<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Udacity Todos Goals</title>

    <link rel="stylesheet" href="index.css" />
  </head>

  <body>
    <main>
      <section id="app">
        <h2 style="display: none">React App</h2>
      </section>
    </main>

    <!-- React -->
    <script src="https://unpkg.com/react@16.3.0-alpha.1/umd/react.development.js"></script>

    <!-- ReactDOM -->
    <script src="https://unpkg.com/react-dom@16.3.0-alpha.1/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>

    <!-- Redux -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>

    <!-- API  -->
    <script src="https://tylermcginnis.com/goals-todos-api/index.js"></script>

    <script src="index.js"></script>
    <script type="text/babel">
      /**
       * Definition for TODO
       * @typedef {Object} todo
       * @property {string} id - todo ID
       * @property {boolean} complete - todo complete status
       * @property {string} name - todo name
       */

      /**
       * Definition for Goal
       * @typedef {Object} goal
       * @property {string} id - goal ID
       * @property {string} name - goal name
       */

      /**
       * Definition for id
       * @typedef {string} id - object ID
       */

      /**
       * Renders the List component UI
       * @returns {object} - The UI DOM object
       * @param {object} props - List component props
       * @param {todo[] | goal[]} props.items - The list items
       * @param {function} props.remove - Remove item function
       * @param {function} [props.toggle] - Toggle todo function
       */
      const List = ({ items, remove, toggle }) => (
        <ul>
          {items.map((item) => (
            <li key={item.id}>
              <span
                onClick={() => toggle && toggle(item.id)}
                style={{ textDecoration: item.complete && "line-through" }}
              >
                {item.name}
              </span>
              <button onClick={() => remove(item)}>X</button>
            </li>
          ))}
        </ul>
      );

      /**
       * Todos component
       * @constructor
       */
      class Todos extends React.Component {
        /**
         * Adds a todo
         * @param {object} e - JS event object
         * @returns {Promise}
         */
        addItem = (e) => {
          e.preventDefault();

          return API.saveTodo(this.input.value)
            .then((todo) => {
              this.input.value = "";
              this.props.store.dispatch(addTodoAction(todo));
            })
            .catch(() => alert("An error occurred. Try again"));
        };

        /**
         * Remove a todo
         * @param {todo} todo - The todo to remove
         * @returns {Promise}
         */
        removeItem = (todo) => {
          this.props.store.dispatch(removeTodoAction(todo.id));

          return API.deleteTodo(todo.id).catch(() => {
            alert("An error occurred. Try again");
            this.props.store.dispatch(addTodoAction(todo));
          });
        };

        /**
         * Toggle a todo
         * @param {id} id - The todo id to toggle
         * @returns {Promise}
         */
        toggleItem = (id) => {
          this.props.store.dispatch(toggleTodoAction(id));

          return API.saveTodoToggle(id).catch(() => {
            alert("An error occurred. Try again");
            this.props.store.dispatch(toggleTodoAction(id));
          });
        };

        /**
         * Renders the Todos component UI
         * @returns {object} - The UI DOM object
         */
        render() {
          return (
            <div>
              <h1>Todos List</h1>

              <form>
                <input
                  type="text"
                  placeholder="Add Todo"
                  aria-label="todo"
                  ref={(input) => (this.input = input)}
                />
                <button onClick={this.addItem}>Add Todo</button>
              </form>

              <List
                items={this.props.todos}
                remove={this.removeItem}
                toggle={this.toggleItem}
              />
            </div>
          );
        }
      }

      /**
       * Goals component
       * @constructor
       */
      class Goals extends React.Component {
        /**
         * Adds a goal
         * @param {object} e - JS event object
         * @returns {Promise}
         */
        addItem = (e) => {
          e.preventDefault();

          return API.saveGoal(this.input.value)
            .then((goal) => {
              this.input.value = "";

              this.props.store.dispatch(addGoalAction(goal));
            })
            .catch(() => alert("An error occurred. Try again"));
        };

        /**
         * Removes a goal
         * @param {goal} goal - The goal to remove
         * @returns {Promise}
         */
        removeItem = (goal) => {
          this.props.store.dispatch(removeGoalAction(goal.id));

          return API.deleteGoal(goal.id).catch(() => {
            alert("An error occurred. Try again");
            this.props.store.dispatch(addGoalAction(goal));
          });
        };

        /**
         * Renders the Goals component UI
         * @returns {object} - the UI DOM object
         */
        render() {
          return (
            <div>
              <h1>Goals</h1>

              <form>
                <input
                  type="text"
                  placeholder="Add Goal"
                  aria-label="goal"
                  ref={(input) => (this.input = input)}
                />

                <button onClick={this.addItem}>Add Goal</button>
              </form>
              <List items={this.props.goals} remove={this.removeItem} />
            </div>
          );
        }
      }

      /**
       * App component
       * @constructor
       */
      class App extends React.Component {
        /**
         * Lifecycle method that runs after component has mounted
         */
        componentDidMount() {
          this.props.store.subscribe(() => this.forceUpdate());

          Promise.all([API.fetchGoals(), API.fetchTodos()]).then(
            ([goals, todos]) => {
              this.props.store.dispatch(receiveDataAction(goals, todos));
            }
          );
        }

        /**
         * Renders the App component UI
         * @returns {object} - The UI DOM object
         */
        render() {
          const { store } = this.props;

          const { loading, todos, goals } = store.getState();

          return !loading ? (
            <h3>loading</h3>
          ) : (
            <div>
              <h2>App</h2>
              <Todos store={store} todos={todos} />
              <Goals store={store} goals={goals} />
            </div>
          );
        }
      }

      ReactDOM.render(<App store={store} />, document.getElementById("app"));
    </script>
  </body>
</html>
